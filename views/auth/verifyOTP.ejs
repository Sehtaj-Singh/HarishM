<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/auth1.css" />

    <title>Verify OTP</title>
  </head>
  <body>
    <%- include(`../partials/fonts`) %>

    <div id="box-up">
      <div id="up-t"></div>
      <div id="up-t2"></div>
    </div>

    <div id="login-wrapR">
      <h1 id="title">Enter OTP</h1>

      <% if (maskedPhone) { %>
    <p id="verify-title">
      OTP sent to WhatsApp number : <br /><strong id="mask-no"
        ><%= maskedPhone %></strong
      >
    </p>
    <% } %>

      <form id="verify-otp" action="<%= otpAction %>" method="POST">
        <input type="hidden" name="verifyType" value="<%= verifyType %>" />
        <input type="hidden" name="verifyID" value="<%= verifyID %>" />

        <div class="inputGroup">
          <input
            id="verify-input"
            type="text"
            name="otp"
            maxlength="6"
            pattern="[0-9]{6}"
            placeholder=" "
            required
          />
          <label>6-digit OTP Code</label>
        </div>

        <% if (error) { %>
        <p style="color: red; text-align: center; font-family: 'Inika', serif">
          <%= error %>
        </p>
        <% } %>

        <button id="verify-btn" type="submit">Verify</button>
      </form>

      <form id="resendForm" method="POST" action="/resend-otp">
        <input type="hidden" name="verifyType" value="<%= verifyType %>" />
        <input type="hidden" name="verifyID" value="<%= verifyID %>" />
        <p id="resend-otp">
          Didnâ€™t receive OTP?<br />
          <button type="submit" id="resendBtn">Resend</button><br />
          <span id="resendMsg"></span>
        </p>
      </form>
    </div>

    <div id="box-down">
      <div id="down-t"></div>
      <div id="down-t2"></div>
      <div id="down-t3"></div>
      <div id="down-t4"></div>
    </div>

    

    <script>
      const resendForm = document.getElementById("resendForm");
      const resendBtn = document.getElementById("resendBtn");
      const resendMsg = document.getElementById("resendMsg");
      let resendCountdown; // To clear existing interval

      resendForm.addEventListener("submit", function (e) {
        e.preventDefault(); // Prevent full page post

        if (resendBtn.disabled) return;
        resendBtn.disabled = true;
        resendBtn.textContent = "Sending...";

        const formData = new FormData(resendForm);

        fetch(resendForm.action, {
          method: "POST",
          body: new URLSearchParams(formData),
        })
          .then((response) => {
            if (!response.ok) throw new Error("Failed to resend OTP");
            return response.text();
          })
          .then(() => {
            resendMsg.textContent = "OTP resent successfully.";
            startCountdown(30); // 30 second timer
          })
          .catch(() => {
            resendMsg.textContent = "Error resending OTP.";
            resendBtn.disabled = false;
            resendBtn.textContent = "Resend";
          });
      });

      function startCountdown(seconds) {
        if (resendCountdown) clearInterval(resendCountdown);
        let timeLeft = seconds;
        resendBtn.textContent = `Resend in ${timeLeft}s`;
        resendBtn.disabled = true;

        resendCountdown = setInterval(() => {
          timeLeft--;
          resendBtn.textContent = `Resend in ${timeLeft}s`;
          if (timeLeft <= 0) {
            clearInterval(resendCountdown);
            resendBtn.disabled = false;
            resendBtn.textContent = "Resend";
            resendMsg.textContent = "";
          }
        }, 1000);
      }
    </script>
  </body>
</html>
