<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= product.SHname %> - harishMobile</title>
    <script
      src="https://kit.fontawesome.com/3a523928fc.js"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="/css/storeHeader.css" />
    <link rel="stylesheet" href="/css/detailPage.css" />
  </head>
  <body>
    <%- include(`../partials/storeHeader`) %>
    <%- include(`../partials/fonts`) %>
    <%- include(`../partials/cartAddToast`) %>
    <script src="/javascript/store.js"></script>
    <script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.spec-tile .spec-head').forEach(btn => {
    btn.addEventListener('click', () => {
      const tile = btn.closest('.spec-tile');
      const body = tile.querySelector('.spec-body');
      const nowOpen = tile.classList.toggle('open');
      btn.setAttribute('aria-expanded', nowOpen ? 'true' : 'false');
      body.hidden = !nowOpen;

      if (nowOpen) {
        body.style.maxHeight = body.scrollHeight + 'px';
      } else {
        body.style.maxHeight = 0;
      }
    });
  });
});
</script>


    <a class="back-btn" href="/"><i class="fa-solid fa-arrow-left"></i>  Back</a>

    <!-- Product detail slider -->
<div id="upwrapIS">
  <section id="imageSlider">
    <div class="carousel" id="carousel">
      <div class="carousel-track">
        <% if (product.productDetail && product.productDetail.images && product.productDetail.images.length) { %>
          <!-- First image -->
          <img id="slide" src="/uploads/<%= product.productDetail.images[0] %>" alt="Detail 1" />

          <!-- Video goes second if exists -->
          <% if (product.productDetail.video) { %>
            <video id="slide" src="/uploads/<%= product.productDetail.video %>" controls></video>
          <% } %>

          <!-- Remaining images -->
          <% product.productDetail.images.slice(1).forEach(function(img, idx) { %>
            <img id="slide" src="/uploads/<%= img %>" alt="Detail <%= idx+2 %>" />
          <% }); %>
        <% } %>
      </div>
      <div class="carousel-dots" id="dots"></div>
    </div>
  </section>
</div>

<!-- Product title + category -->
<div class="pd-head">
  <% const categoryLabel = { SH: 'Refurbished', N: 'New' }[product.category]; %>
  <h1 class="pd-title">
    <%= product.name %><%= categoryLabel ? ' - ' + categoryLabel : '' %>
  </h1>
</div>



<!-- Condition + Specs -->
<% 
  const _s = v => (v == null ? '' : String(v).trim());
  const ramV = _s(product.specs?.memory?.ram);
  const stoV = _s(product.specs?.memory?.storage);
  const colV = _s(product.specs?.design?.color);
  const addGB = v => v ? (/\d/.test(v) && !/gb/i.test(v) ? `${v}GB` : v) : '';
  const ram = addGB(ramV);
  const storage = addGB(stoV);
%>

<div class="pd-specs">
  <% if (product.condition) { %>
    <div class="detail-row">
      <span class="detail-label">Condition :</span>
      <span class="detail-value"><%= product.condition %></span>
    </div>
  <% } %>

  <% if (ram) { %>
    <div class="detail-row">
      <span class="detail-label">RAM :</span>
      <span class="detail-value"><%= ram %></span>
    </div>
  <% } %>

  <% if (storage) { %>
    <div class="detail-row">
      <span class="detail-label">Storage :</span>
      <span class="detail-value"><%= storage %></span>
    </div>
  <% } %>

  <% if (colV) { %>
    <div class="detail-row">
      <span class="detail-label">Color :</span>
      <span class="detail-value"><%= colV %></span>
    </div>
  <% } %>
</div>

<!-- Price Section -->
<div class="pd-price">
  <div class="price-current">â‚¹<%= product.price %></div>
  
    <% if (product.mrp) { %>
    <div class="price-mrp"><s>â‚¹<%= product.mrp %></s></div>
      <% } %>
      <% if (product.discount) { %>
    <div class="price-discount"><%= product.discount %>% Off</div>
  <% } %>
  
  
</div>

<!-- Assurance badges -->
<div class="assurance-wrap" aria-label="Assurance details">
  <div class="assurance-item" role="group" aria-label="7-day exchange">
    <i class="fa-solid fa-arrows-rotate" aria-hidden="true"></i>
    <span>7-day exchange</span>
  </div>

  <div class="assurance-item" role="group" aria-label="Secure delivered">
    <i class="fa-solid fa-truck-fast" aria-hidden="true"></i>
    <span>Secure delivered</span>
  </div>

  <div class="assurance-item" role="group" aria-label="No return allowed">
    <i class="fa-solid fa-ban" aria-hidden="true"></i>
    <span>No return allowed</span>
  </div>
</div>

<!-- Product Details / Specifications -->
<section class="specs-section" id="specs">
  <h2 class="specs-title">Specification</h2>

  <% 
    const sectionMap = [
      ['general','General'],
      ['backCamera','Rear Camera'],
      ['memory','Memory & Storage'],
      ['selfieCamera','Front Camera'],
      ['design','Design'],
      ['display','Display'],
      ['connectivity','Network & Connectivity'],
      ['performance','Performance'],
      ['battery','Battery'],
      ['sound','Sound'],
      ['sensors','Sensors'],
    ];
  %>

  <div class="specs-tiles" id="specsTiles">
    <% sectionMap.forEach(([key, label]) => {
         const sec = product.specs?.[key] || {};
         const entries = Object.entries(sec)
           .filter(([k,v]) => k !== 'merged' && v && String(v).trim() !== '');
         if (entries.length) { %>

      <div class="spec-tile">
        <button class="spec-head" type="button" aria-expanded="false">
          <span><%= label %></span>
          <i class="fa-solid fa-chevron-down" aria-hidden="true"></i>
        </button>

        <div class="spec-body" hidden>
          <ul class="spec-list">
            <% entries.forEach(([k, v]) => {
                 const prettyKeyMap = {
                   cpu:'Processor', ram:'RAM', storage:'Storage', wifi:'Wi-Fi',
                   bluetooth:'Bluetooth', jack:'3.5mm Jack', stereoSpeaker:'Stereo Speaker',
                   screenToBodyRatio:'Screen-to-body ratio', refreshRate:'Refresh rate',
                   peakBrightness:'Peak brightness', osSystem:'OS', osUpdates:'OS updates',
                   securityUpdates:'Security updates', chargingPort:'Charging port',
                   simSize:'SIM size', countryOfOrigin:'Country of origin',
                   video:'Video', type:'Type', capacity:'Capacity', charging:'Charging',
                   wirelessCharging:'Wireless charging', fingerprint:'Fingerprint',
                   other:'Other', dimensions:'Dimensions', buildMaterial:'Build material',
                   model:'Model', dualSim:'Dual SIM', protection:'Protection',
                   notch:'Notch', network:'Network', color:'Color', size:'Size',
                   resolution:'Resolution', weight:'Weight'
                 };
                 const pretty = prettyKeyMap[k] || k.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
                 const val = (v instanceof Date || (typeof v === 'string' && !isNaN(Date.parse(v))))
                   ? new Date(v).toLocaleDateString('en-IN')
                   : v;
            %>
              <li>
                <span class="spec-name"><%= pretty %></span>
                <span class="spec-value"><%= val %></span>
              </li>
            <% }) %>
          </ul>
        </div>
      </div>

    <% } }); %>
  </div>

  <!-- See more / See less button -->
  <div class="see-more-wrap">
    <button id="seeMoreBtn" class="see-more-btn" type="button">See more</button>
  </div>
</section>

<!-- Inline script -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  /* ---------- Individual Spec Tile Expand/Collapse ---------- */
  document.querySelectorAll('.spec-tile .spec-head').forEach(btn => {
    btn.addEventListener('click', () => {
      const tile = btn.closest('.spec-tile');
      const body = tile.querySelector('.spec-body');
      const nowOpen = tile.classList.toggle('open');
      btn.setAttribute('aria-expanded', nowOpen ? 'true' : 'false');
      body.hidden = !nowOpen;

      if (nowOpen) {
        body.style.maxHeight = body.scrollHeight + 'px';
      } else {
        body.style.maxHeight = 0;
      }
    });
  });

  /* ---------- See More / See Less Feature ---------- */
  const specsSection = document.getElementById("specs");
  const specsTiles = document.getElementById("specsTiles");
  const seeMoreBtn = document.getElementById("seeMoreBtn");
  const allTiles = specsTiles.querySelectorAll(".spec-tile");
  const visibleCount = 3;
  let expanded = false;

  // Default collapsed state
  if (allTiles.length > visibleCount) {
    allTiles.forEach((tile, i) => {
      if (i >= visibleCount) tile.style.display = "none";
    });
    seeMoreBtn.style.display = "block";
    specsTiles.style.opacity = "0.6";
    specsSection.classList.add("collapsed"); // show black gradient
  } else {
    seeMoreBtn.style.display = "none";
  }

  // Toggle See More / See Less
  seeMoreBtn.addEventListener("click", () => {
    expanded = !expanded;

    if (expanded) {
      // Expand all specs
      allTiles.forEach(tile => (tile.style.display = "block"));
      seeMoreBtn.textContent = "See less";
      specsTiles.style.opacity = "1";
      specsSection.classList.remove("collapsed"); // remove gradient
    } else {
      // Collapse back to first few specs
      allTiles.forEach((tile, i) => {
        tile.style.display = i < visibleCount ? "block" : "none";
      });
      seeMoreBtn.textContent = "See more";
      specsTiles.style.opacity = "0.6";
      specsSection.classList.add("collapsed"); // add gradient
      specsTiles.scrollIntoView({ behavior: "smooth", block: "start" });
    }
  });
});
</script>

    <!-- <div class="product-details">
  <img src="/uploads/<%= product.image %>" alt="<%= product.name %>" width="300" />
  <h1><%= product.name %></h1>

  <% if (product.condition) { %>
    <p>Condition: <%= product.condition %></p>
  <% } %>

  <p>MRP: â‚¹<%= product.mrp %></p>
  <p>Discount: <%= product.discount %>%</p>
  <p>Price: â‚¹<%= product.price %></p> -->

  <form action="/cart/add" method="POST">
    <input type="hidden" name="productId" value="<%= product.id %>" />
    <input type="hidden" name="qty" value="1" />
    <input type="hidden" name="buyNow" value="true" />  <!-- ðŸ‘ˆ Add this -->
    <button type="submit">Buy Now</button>
  </form>
</div>
  </body>
</html>
